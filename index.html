<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Language „Åõ„Çì„Åõ„ÅÑ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Akaya+Telivigala&display=swap" rel="stylesheet" />
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  <style>
    .akaya {
      font-family: 'Akaya Telivigala', cursive;
    }
    
    .fade-transition {
      transition: opacity 0.5s ease;
    }
    input[type="checkbox"]:checked {
      accent-color: #22c55e;
    }
    #xp-bar-container {
      background: #444;
      border-radius: 10px;
      height: 12px;
      width: 100%;
      margin-top: 6px;
      overflow: hidden;
    }
    
    
    #xp-bar-fill {
      background: #facc15;
      height: 100%;
      width: 0%;
      transition: width 0.5s ease;
    }
    .choice-btn {
      background: #2d3748;
      padding: 10px 16px;
      margin: 6px 0;
      border-radius: 10px;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      border: 2px solid transparent;
      transition: background-color 0.3s ease, border-color 0.3s ease;
      user-select: none;
    }
    .choice-btn:hover {
      background-color: #4a5568;
    }
    .choice-btn.correct {
      background-color: #22c55e;
      border-color: #16a34a;
      cursor: default;
    }
    .choice-btn.incorrect {
      background-color: #dc2626;
      border-color: #b91c1c;
      cursor: default;
    }
    .choice-btn:disabled {
      cursor: default;
      opacity: 0.75;
    }
    #double-xp-timer-box {
      display: none;
      background: #fff;
      color: #7c3aed;
      border: 2px solid #a78bfa;
      border-radius: 16px;
      padding: 12px 0;
      font-size: 1.1rem;
      font-weight: bold;
      box-shadow: 0 4px 32px rgba(124,58,237,0.12);
      min-width: 80%;
      text-align: center;
      letter-spacing: 1px;
      margin: 0.5rem auto 0 auto;
      transition: opacity 0.4s;
      font-family: inherit;
    }
    #double-xp-timer-box.show {
      display: block;
      opacity: 1;
    }
    #double-xp-timer-box.hide {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      
      /* Fade transition for modal */
.inventory-fade {
  opacity: 0;
  transition: opacity 0s ease;
  pointer-events: none;
}
.inventory-fade.show {
  opacity: 1;
  pointer-events: auto;
}
    }
  </style>
</head>



<body class="bg-[#1E1E1E] text-white font-sans flex">



  <!-- Sidebar -->
  <aside class="w-64 bg-[#2A2A2A] min-h-screen p-6 flex flex-col gap-">
    <!-- Streak at top -->
    <div class="bg-[#1E1E1E] p-4 rounded-xl text-center shadow-lg">
      <p class="text-3xl font-bold">üî• <span id="streak-days">0</span> Day Streak!</p>
      <div id="xp-container" class="mt-2 px-2">
        <div id="xp-bar-container">
          <div id="xp-bar-fill"></div>
        </div>
        <p id="xp-text" class="text-yellow-400 text-sm text-center mt-1">XP: 0 / 10</p>
        <p id="total-xp-text" class="text-yellow-300 text-xs text-center mt-1">Total XP: 0</p>
        <button id="double-xp-btn" class="mt-2 w-full bg-purple-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-800 transition text-base">
          2x XP (Free)
        </button>
        <div id="double-xp-timer-box">
          <span id="double-xp-timer-text">2x XP active: 10:00</span>
        </div>
      </div>
    </div>
    <div>
      <h2 class="text-xl font-bold mb-2"></h2>
      <button id="lang-toggle" class="bg-red-600 text-white px-4 py-2 rounded-lg akaya text-xl w-full">
        Japanese
      </button>
      <div id="lang-options" class="mt-2 space-y-2 opacity-0 hidden fade-transition pointer-events-none">
        <button id="hiragana-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg akaya text-lg w-11/12 ml-2">
          Hiragana
        </button>
        <button id="katakana-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg akaya text-lg w-11/12 ml-2">
          Katakana
        </button>
        <button id="kanji-btn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg akaya text-lg w-11/12 ml-2">
          Kanji
        </button>
        <button id="words-btn" disabled class="bg-green-800 text-white px-4 py-2 rounded-lg akaya text-lg w-11/12 ml-2">
          Words
        </button>
      
      </div>
    </div>
    <button id="open-inventory-btn" class="w-full bg-green-700 text-white py-2 rounded-lg mt-4 hover:bg-green-800 text-lg font-bold">
  üçµ Inventory
</button>

  
  </aside>
  

  <!-- Main Content -->
  <div class="flex-1 relative">
    <header class="bg-[#2A2A2A] p-6 relative z-10">
      <h1 class="text-3xl font-bold">Language „Åõ„Çì„Åõ„ÅÑ</h1>
    </header>
    <div id="curved-top" class="absolute top-[-60px] left-0 w-full h-[120px] bg-[#2A2A2A] rounded-b-[100px] z-0 hidden"></div>
    <div id="welcome-text" class="relative z-10 mt-16 px-6 fade-transition">
      <div class="bg-[#2A2A2A] p-6 rounded-xl shadow-lg max-w-md mx-auto">
        <p class="text-lg text-center">Welcome to Language „Åõ„Çì„Åõ„ÅÑ!</p>
      </div>
    </div>
    <!-- Hiragana Section -->
    <div id="hiragana-section" class="relative z-10 mt-16 px-6 fade-transition hidden">
      <div class="max-w-2xl mx-auto">
        <div id="hiragana-grid" class="grid grid-cols-5 gap-2"></div>
        <div class="flex justify-between mt-4">
          <button id="select-all-btn-h" class="bg-green-600 px-4 py-2 rounded-lg akaya text-white hover:bg-green-700">Select All</button>
          <button id="deselect-all-btn-h" class="bg-red-600 px-4 py-2 rounded-lg akaya text-white hover:bg-red-700">Deselect All</button>
        </div>
        <button id="start-quiz-btn-h" class="bg-blue-600 mt-6 w-full py-3 rounded-lg akaya text-white text-xl hover:bg-blue-700">
          Start Quiz
        </button>
      </div>
    </div>
    <!-- Katakana Section -->
    <div id="katakana-section" class="relative z-10 mt-16 px-6 fade-transition hidden">
      <div class="max-w-2xl mx-auto">
        <div id="katakana-grid" class="grid grid-cols-5 gap-2"></div>
        <div class="flex justify-between mt-4">
          <button id="select-all-btn-k" class="bg-green-600 px-4 py-2 rounded-lg akaya text-white hover:bg-green-700">Select All</button>
          <button id="deselect-all-btn-k" class="bg-red-600 px-4 py-2 rounded-lg akaya text-white hover:bg-red-700">Deselect All</button>
        </div>
        <button id="start-quiz-btn-k" class="bg-blue-600 mt-6 w-full py-3 rounded-lg akaya text-white text-xl hover:bg-blue-700">
          Start Quiz
        </button>
      </div>
    </div>
    <!-- Kanji Section -->
    <div id="kanji-section" class="relative z-10 mt-16 px-6 fade-transition hidden">
      <div class="max-w-2xl mx-auto">
        <div id="kanji-grid" class="grid grid-cols-5 gap-2"></div>
        <div class="flex justify-between mt-4">
          <button id="select-all-btn-kanji" class="bg-green-600 px-4 py-2 rounded-lg akaya text-white hover:bg-green-700">Select All</button>
          <button id="deselect-all-btn-kanji" class="bg-red-600 px-4 py-2 rounded-lg akaya text-white hover:bg-red-700">Deselect All</button>
        </div>
        <button id="start-quiz-btn-kanji" class="bg-blue-600 mt-6 w-full py-3 rounded-lg akaya text-white text-xl hover:bg-blue-700">
          Start Quiz
        </button>
      </div>
    </div>
    <!-- Words Section -->
    <div id="words-section" class="relative z-10 mt-16 px-6 fade-transition hidden">
      <div class="max-w-2xl mx-auto">
        <div class="text-center text-white text-xl mb-3">Match the word with its correct hiragana!</div>
        <div id="words-quiz-container"></div>
        <button id="start-quiz-btn-words" class="bg-blue-600 mt-6 w-full py-3 rounded-lg akaya text-white text-xl hover:bg-blue-700">
          Start Word Quiz
        </button>
      </div>
      
    </div>
    
    <!-- Quiz Section (reused) -->
    <div id="quiz-container" class="relative z-10 mt-16 px-6 max-w-2xl mx-auto hidden fade-transition">
      <p id="quiz-question" class="text-5xl akaya mb-6" style="color: white;"></p>
      <div id="choices-container" class="flex flex-col"></div>
      <div class="flex justify-between mt-6">
        <button id="skip-question-btn" class="bg-yellow-500 px-4 py-2 rounded-lg akaya text-white hover:bg-yellow-600">Skip</button>
        <button id="go-back-btn" class="bg-gray-600 px-4 py-2 rounded-lg akaya text-white hover:bg-gray-700 hidden">Go Back</button>
      </div>
      <p id="feedback" class="text-lg min-h-[24px] mt-4"></p>
      <p id="score-display" class="text-lg font-bold mt-2"></p>
    </div>
    <!-- Words Quiz Only Section (choices handled separately) -->
    <div id="words-quiz-game" class="relative z-10 mt-16 px-6 max-w-2xl mx-auto hidden fade-transition">
      <div id="words-quiz-word" class="text-3xl font-bold text-center mb-6"></div>
      <div id="words-quiz-choices" class="flex flex-wrap justify-center gap-4 mb-6"></div>
      <p id="words-quiz-feedback" class="text-lg min-h-[24px] mt-4 text-center"></p>
      <p id="words-quiz-score" class="text-lg font-bold mt-2 text-center"></p>
      <button id="words-quiz-next-btn" class="hidden bg-blue-600 mx-auto px-5 py-2 rounded-lg akaya text-white text-lg hover:bg-blue-700">Next</button>
      <button id="words-quiz-finish-btn" class="hidden bg-green-600 mx-auto px-5 py-2 rounded-lg akaya text-white text-lg hover:bg-green-700">Finish</button>
      <button id="words-quiz-back-btn" class="bg-gray-600 mx-auto px-5 py-2 rounded-lg akaya text-white text-lg hover:bg-gray-700 mt-6 hidden">Go Back</button>
    </div>
  </div>
<div id="inventory-modal" class="inventory-fade" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(20,20,20,0.6); z-index:1000; align-items:center; justify-content:center;">
  <div style="background-color: #2A2A2A;" class="rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto relative shadow-lg border border-gray-700">
    <!-- Close button -->
    <button id="close-inventory-btn" type="button" class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-700" aria-label="Close">
      ‚úï
    </button>
    
    <!-- Title -->
    <h2 class="text-2xl font-bold mb-6 text-white">Inventory</h2>

    <!-- Sushi Section -->
    <div class="flex items-center gap-4 mb-5">
      <span style="font-size:2.4rem;">üç£</span>
      <div class="flex-1">
        <div class="font-bold text-lg text-white">Sushi</div>
        <div class="text-blue-300 mb-2">Count: <span id="sushi-count-modal">0</span> / 3</div>
        <div class="text-xs text-gray-400 mb-2">+20 XP per use</div>
        <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
          <div id="sushi-progress-bar" class="bg-blue-500 rounded-full h-2" style="width: 0%"></div>
        </div>
        <div class="text-xs text-gray-400 mb-2">Progress: <span id="sushi-progress-text">0</span>/50 XP</div>
        <button onclick="useSushi(true)" id="use-sushi-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold transition-colors">
          Use Sushi
        </button>
      </div>
    </div>

    <!-- Egg Section -->
    <div class="border-t border-gray-700 my-6"></div>
    <div class="flex items-center gap-4 mb-5">
      <span style="font-size:2.4rem;">ü•ö</span>
      <div class="flex-1">
        <div class="font-bold text-lg text-white">Mystery Egg</div>
        <div class="text-purple-300 mb-2">
          <span id="egg-status">No egg available</span>
        </div>
        <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
          <div id="egg-progress-bar" class="bg-purple-500 rounded-full h-2" style="width: 0%"></div>
        </div>
        <div class="text-xs text-gray-400 mb-2">Progress: <span id="egg-progress-text">0</span>/100 XP</div>
        <button onclick="hatchEgg()" id="hatch-egg-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-bold transition-colors hidden">
          Hatch Egg
        </button>
      </div>
    </div>

    <!-- Pet Collection -->
    <div class="border-t border-gray-700 my-6"></div>
    <div class="mb-4">
      <h3 class="text-lg font-bold mb-3 text-white">Pet Collection</h3>
      <div class="grid grid-cols-5 gap-2" id="pets-collection">
        <!-- Pet slots will be generated here -->
      </div>
    </div>
  </div>
</div>

<script>
// Modal logic: open/close with correct background and close button
function toggleInventoryModal(show = true) {
  const modal = document.getElementById('inventory-modal');
  if (!modal) return;
  if (show) {
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
    updateSushiDisplays();
    updateEggDisplays();
    updatePetsCollection();
  } else {
    modal.classList.remove('show');
    setTimeout(() => { modal.style.display = 'none'; }, 150);
  }
}
document.getElementById('open-inventory-btn').onclick = () => toggleInventoryModal(true);
document.getElementById('close-inventory-btn').onclick = () => toggleInventoryModal(false);
// Also close modal if user clicks background (optional)
document.getElementById('inventory-modal').addEventListener('click', function(e) {
  if (e.target === this) toggleInventoryModal(false);
});
</script>


  <script>
    // --- Character Sets ---
    const hiraganaCharacters = [
      ['„ÅÇ', 'a'], ['„ÅÑ', 'i'], ['„ÅÜ', 'u'], ['„Åà', 'e'], ['„Åä', 'o'],
      ['„Åã', 'ka'], ['„Åç', 'ki'], ['„Åè', 'ku'], ['„Åë', 'ke'], ['„Åì', 'ko'],
      ['„Åï', 'sa'], ['„Åó', 'shi'], ['„Åô', 'su'], ['„Åõ', 'se'], ['„Åù', 'so'],
      ['„Åü', 'ta'], ['„Å°', 'chi'], ['„Å§', 'tsu'], ['„Å¶', 'te'], ['„Å®', 'to'],
      ['„Å™', 'na'], ['„Å´', 'ni'], ['„Å¨', 'nu'], ['„Å≠', 'ne'], ['„ÅÆ', 'no'],
      ['„ÅØ', 'ha'], ['„Å≤', 'hi'], ['„Åµ', 'fu'], ['„Å∏', 'he'], ['„Åª', 'ho'],
      ['„Åæ', 'ma'], ['„Åø', 'mi'], ['„ÇÄ', 'mu'], ['„ÇÅ', 'me'], ['„ÇÇ', 'mo'],
      ['„ÇÑ', 'ya'], ['„ÇÜ', 'yu'], ['„Çà', 'yo'],
      ['„Çâ', 'ra'], ['„Çä', 'ri'], ['„Çã', 'ru'], ['„Çå', 're'], ['„Çç', 'ro'],
      ['„Çè', 'wa'], ['„Çí', 'wo'], ['„Çì', 'n']
    ];

    const katakanaCharacters = [
      ['„Ç¢', 'a'], ['„Ç§', 'i'], ['„Ç¶', 'u'], ['„Ç®', 'e'], ['„Ç™', 'o'],
      ['„Ç´', 'ka'], ['„Ç≠', 'ki'], ['„ÇØ', 'ku'], ['„Ç±', 'ke'], ['„Ç≥', 'ko'],
      ['„Çµ', 'sa'], ['„Ç∑', 'shi'], ['„Çπ', 'su'], ['„Çª', 'se'], ['„ÇΩ', 'so'],
      ['„Çø', 'ta'], ['„ÉÅ', 'chi'], ['„ÉÑ', 'tsu'], ['„ÉÜ', 'te'], ['„Éà', 'to'],
      ['„Éä', 'na'], ['„Éã', 'ni'], ['„Éå', 'nu'], ['„Éç', 'ne'], ['„Éé', 'no'],
      ['„Éè', 'ha'], ['„Éí', 'hi'], ['„Éï', 'fu'], ['„Éò', 'he'], ['„Éõ', 'ho'],
      ['„Éû', 'ma'], ['„Éü', 'mi'], ['„É†', 'mu'], ['„É°', 'me'], ['„É¢', 'mo'],
      ['„É§', 'ya'], ['„É¶', 'yu'], ['„É®', 'yo'],
      ['„É©', 'ra'], ['„É™', 'ri'], ['„É´', 'ru'], ['„É¨', 're'], ['„É≠', 'ro'],
      ['„ÉØ', 'wa'], ['„É≤', 'wo'], ['„É≥', 'n']
    ];

    // 50+ basic kanji (first grade/common) and readings:
    const kanjiCharacters = [
      ['Êó•', '„Å´„Å°'], ['‰∏Ä', '„ÅÑ„Å°'], ['ÂõΩ', '„Åè„Å´'], ['‰∫∫', '„Å≤„Å®'], ['Âπ¥', '„Å≠„Çì'],
      ['Â§ß', '„Åä„Åä'], ['ÂçÅ', '„Åò„ÇÖ„ÅÜ'], ['‰∫å', '„Å´'], ['Êú¨', '„Åª„Çì'], ['‰∏≠', '„Å™„Åã'],
      ['Èï∑', '„Å™„Åå'], ['Âá∫', '„Åß'], ['‰∏â', '„Åï„Çì'], ['ÊôÇ', '„Åò'], ['Ë°å', '„ÅÑ'],
      ['Ë¶ã', '„Åø'], ['Êúà', '„Å§„Åç'], ['ÂàÜ', '„Åµ„Çì'], ['Âæå', '„ÅÇ„Å®'], ['Ââç', '„Åæ„Åà'],
      ['Áîü', '„Åõ„ÅÑ'], ['‰∫î', '„Åî'], ['Èñì', '„ÅÇ„ÅÑ„Å†'], ['‰∏ä', '„ÅÜ„Åà'], ['Êù±', '„Å≤„Åå„Åó'],
      ['Âõõ', '„Çà„Çì'], ['‰ªä', '„ÅÑ„Åæ'], ['Èáë', '„Åç„Çì'], ['‰πù', '„Åç„ÇÖ„ÅÜ'], ['ÂÖ•', '„ÅÑ'],
      ['Â≠¶', '„Åå„Åè'], ['È´ò', '„Åü„Åã'], ['ÂÜÜ', '„Åà„Çì'], ['Â≠ê', '„Åì'], ['Â§ñ', '„Åù„Å®'],
      ['ÂÖ´', '„ÅØ„Å°'], ['ÂÖ≠', '„Çç„Åè'], ['‰∏ã', '„Åó„Åü'], ['Êù•', '„Åè'], ['Ê∞ó', '„Åç'],
      ['Â∞è', '„Å°„ÅÑ'], ['‰∏É', '„Å™„Å™'], ['Â±±', '„ÇÑ„Åæ'], ['Ë©±', '„ÅØ„Å™„Åó'], ['Â•≥', '„Åä„Çì„Å™'],
      ['Âåó', '„Åç„Åü'], ['Âçà', '„Åî'], ['Áôæ', '„Å≤„ÇÉ„Åè'], ['Êõ∏', '„Åã'], ['ÂÖà', '„Åï„Åç']
    ];

    // 50 Simple Common Japanese words for the word-to-hiragana quiz
    const commonWords = [
      { word: "„ÅÇ„Çä„Åå„Å®„ÅÜ", meaning: "thank you", romaji: "arigatou" },
      { word: "„Åì„Çì„Å´„Å°„ÅØ", meaning: "hello", romaji: "konnichiwa" },
      { word: "„Åï„Çà„ÅÜ„Å™„Çâ", meaning: "goodbye", romaji: "sayounara" },
      { word: "„ÅØ„ÅÑ", meaning: "yes", romaji: "hai" },
      { word: "„ÅÑ„ÅÑ„Åà", meaning: "no", romaji: "iie" },
      { word: "„Åä„ÅØ„Çà„ÅÜ", meaning: "good morning", romaji: "ohayou" },
      { word: "„Åì„Çì„Å∞„Çì„ÅØ", meaning: "good evening", romaji: "konbanwa" },
      { word: "„Åô„Åø„Åæ„Åõ„Çì", meaning: "excuse me/sorry", romaji: "sumimasen" },
      { word: "„Åî„ÇÅ„Çì„Å™„Åï„ÅÑ", meaning: "I‚Äôm sorry", romaji: "gomennasai" },
      { word: "„Åä„Å≠„Åå„ÅÑ", meaning: "please", romaji: "onegai" },
      { word: "„Çè„Åã„Çä„Åæ„Åô", meaning: "I understand", romaji: "wakarimasu" },
      { word: "„Çè„Åã„Çä„Åæ„Åõ„Çì", meaning: "I don't understand", romaji: "wakarimasen" },
      { word: "„Åü„Åπ„Åæ„Åô", meaning: "eat", romaji: "tabemasu" },
      { word: "„ÅÆ„Åø„Åæ„Åô", meaning: "drink", romaji: "nomimasu" },
      { word: "„Åø„Åæ„Åô", meaning: "see", romaji: "mimasu" },
      { word: "„Åç„Åç„Åæ„Åô", meaning: "listen", romaji: "kikimasu" },
      { word: "„ÅØ„Å™„Åó„Åæ„Åô", meaning: "speak", romaji: "hanashimasu" },
      { word: "„ÅÑ„Åç„Åæ„Åô", meaning: "go", romaji: "ikimasu" },
      { word: "„Åç„Åæ„Åô", meaning: "come", romaji: "kimasu" },
      { word: "„Åó„Åæ„Åô", meaning: "do", romaji: "shimasu" },
      { word: "„Å®„ÇÇ„Å†„Å°", meaning: "friend", romaji: "tomodachi" },
      { word: "„Åõ„Çì„Åõ„ÅÑ", meaning: "teacher", romaji: "sensei" },
      { word: "„Åå„Åè„Åõ„ÅÑ", meaning: "student", romaji: "gakusei" },
      { word: "„Å≤„Å®", meaning: "person", romaji: "hito" },
      { word: "„ÅÑ„Å¨", meaning: "dog", romaji: "inu" },
      { word: "„Å≠„Åì", meaning: "cat", romaji: "neko" },
      { word: "„ÅÑ„Åà", meaning: "house", romaji: "ie" },
      { word: "„Åè„Çã„Åæ", meaning: "car", romaji: "kuruma" },
      { word: "„Åß„Çì„Åó„ÇÉ", meaning: "train", romaji: "densha" },
      { word: "„Åà„Åç", meaning: "station", romaji: "eki" },
      { word: "„ÇÑ„Åæ", meaning: "mountain", romaji: "yama" },
      { word: "„Åã„Çè", meaning: "river", romaji: "kawa" },
      { word: "„ÅØ„Å™", meaning: "flower", romaji: "hana" },
      { word: "„Åç", meaning: "tree", romaji: "ki" },
      { word: "„Åø„Åö", meaning: "water", romaji: "mizu" },
      { word: "„Åä„Å°„ÇÉ", meaning: "tea", romaji: "ocha" },
      { word: "„Åî„ÅØ„Çì", meaning: "rice/meal", romaji: "gohan" },
      { word: "„Åï„Åã„Å™", meaning: "fish", romaji: "sakana" },
      { word: "„Å´„Åè", meaning: "meat", romaji: "niku" },
      { word: "„ÇÑ„Åï„ÅÑ", meaning: "vegetable", romaji: "yasai" },
      { word: "„Åè„Å†„ÇÇ„ÅÆ", meaning: "fruit", romaji: "kudamono" },
      { word: "„Åõ„Åã„ÅÑ", meaning: "world", romaji: "sekai" },
      { word: "„ÅÜ„Åø", meaning: "sea", romaji: "umi" },
      { word: "„Åù„Çâ", meaning: "sky", romaji: "sora" },
      { word: "„Åç„Çá„ÅÜ", meaning: "today", romaji: "kyou" },
      { word: "„ÅÇ„Åó„Åü", meaning: "tomorrow", romaji: "ashita" },
      { word: "„Åç„ÅÆ„ÅÜ", meaning: "yesterday", romaji: "kinou" },
      { word: "„Å®„Åó„Çá„Åã„Çì", meaning: "library", romaji: "toshokan" },
      { word: "„Åå„Å£„Åì„ÅÜ", meaning: "school", romaji: "gakkou" }
    ];

    // --- State ---
    let quizItems = [];
    let currentIndex = 0;
    let score = 0;
    let questionMode = 0; // 0 = kana -> romaji, 1 = romaji -> kana
    let quizType = ''; // "hiragana", "katakana", "kanji", "words"
    let wordsQuizData = []; // {word, meaning, romaji}
    let wordsQuizCurrent = 0;
    let wordsQuizScore = 0;

    // XP/streak system variables
    const XP_PER_CORRECT = 2;
    const DAILY_XP_MAX = 10;
    let currentXP = 0;
    let currentStreak = 0;
    let totalXP = 0;
    let lastStreakDate = null;

    // 2x XP system
    let isDoubleXpActive = false;
    let doubleXpTimeout = null;
    let doubleXpEndTimestamp = null;
    let doubleXpInterval = null;
    const DOUBLE_XP_DURATION = 10 * 60 * 1000; // 10 minutes in ms

    // --- Element References ---
    const langToggle = document.getElementById('lang-toggle');
    const langOptions = document.getElementById('lang-options');
    const hiraganaBtn = document.getElementById('hiragana-btn');
    const katakanaBtn = document.getElementById('katakana-btn');
    const kanjiBtn = document.getElementById('kanji-btn');
    const wordsBtn = document.getElementById('words-btn');
    const welcomeText = document.getElementById('welcome-text');
    const hiraganaSection = document.getElementById('hiragana-section');
    const katakanaSection = document.getElementById('katakana-section');
    const kanjiSection = document.getElementById('kanji-section');
    const wordsSection = document.getElementById('words-section');
    const curvedTop = document.getElementById('curved-top');
    const hiraganaGrid = document.getElementById('hiragana-grid');
    const katakanaGrid = document.getElementById('katakana-grid');
    const kanjiGrid = document.getElementById('kanji-grid');
    const startQuizBtnH = document.getElementById('start-quiz-btn-h');
    const startQuizBtnK = document.getElementById('start-quiz-btn-k');
    const startQuizBtnKanji = document.getElementById('start-quiz-btn-kanji');
    const startQuizBtnWords = document.getElementById('start-quiz-btn-words');
    const quizContainer = document.getElementById('quiz-container');
    const quizQuestion = document.getElementById('quiz-question');
    const choicesContainer = document.getElementById('choices-container');
    const skipQuestionBtn = document.getElementById('skip-question-btn');
    const feedback = document.getElementById('feedback');
    const scoreDisplay = document.getElementById('score-display');
    const goBackBtn = document.getElementById('go-back-btn');
    const streakDaysEl = document.getElementById('streak-days');
    const xpBarFill = document.getElementById('xp-bar-fill');
    const xpText = document.getElementById('xp-text');
    const totalXpText = document.getElementById('total-xp-text');
    const doubleXpBtn = document.getElementById('double-xp-btn');
    // 2x XP Timer Box
    const doubleXpTimerBox = document.getElementById('double-xp-timer-box');
    const doubleXpTimerText = document.getElementById('double-xp-timer-text');

    // Words quiz game elements
    const wordsQuizContainer = document.getElementById('words-quiz-container');
    const wordsQuizGame = document.getElementById('words-quiz-game');
    const wordsQuizWord = document.getElementById('words-quiz-word');
    const wordsQuizChoices = document.getElementById('words-quiz-choices');
    const wordsQuizFeedback = document.getElementById('words-quiz-feedback');
    const wordsQuizScoreElem = document.getElementById('words-quiz-score');
    const wordsQuizNextBtn = document.getElementById('words-quiz-next-btn');
    const wordsQuizBackBtn = document.getElementById('words-quiz-back-btn');
    const wordsQuizFinishBtn = document.getElementById('words-quiz-finish-btn');


const EGG_XP_REQUIREMENT = 100;
const PETS = {
  KITSUNE: { name: "Kitsune", emoji: "ü¶ä", nickname: "Inari" },
  DRAGON: { name: "Dragon", emoji: "üê≤", nickname: "Ryuu" },
  CRANE: { name: "Crane", emoji: "ü¶¢", nickname: "Tsuru" },
  SHIBA: { name: "Shiba Inu", emoji: "üêï", nickname: "Hachi" },
  KOI: { name: "Koi Fish", emoji: "üê†", nickname: "Sakana" }
};
let hasEgg = false;
let eggProgress = 0;
let unlockedPets = [];

// Add this near your other modal-related code
document.getElementById('open-inventory-btn').addEventListener('click', function() {
  updateEggDisplays();
  updatePetsCollection();
});

// --- Green Tea Inventory System with Modal Menu ---
let greenTeaCount = 0;
const GREEN_TEA_MAX = 5;
const GREEN_TEA_INTERVAL = 15 * 60 * 1000; // 5 min in ms
let greenTeaTimer = null;
let greenTeaLastGiven = parseInt(localStorage.getItem('languageSenseiGreenTeaLastGiven'), 10) || Date.now();

// Add near GREEN_TEA constants
const SUSHI_MAX = 3;
const SUSHI_XP_REQUIREMENT = 50;
const SUSHI_XP_REWARD = 20;
let sushiCount = 0;
let sushiProgress = 0;


// --- Egg and Pet System ---
function saveEggAndPets() {
  localStorage.setItem('languageSenseiEggStatus', hasEgg.toString());
  localStorage.setItem('languageSenseiEggProgress', eggProgress.toString());
  localStorage.setItem('languageSenseiPets', JSON.stringify(unlockedPets));
  console.log('Saved egg progress:', eggProgress); // Debug line
}

function loadEggAndPets() {
  hasEgg = localStorage.getItem('languageSenseiEggStatus') === 'true';
  eggProgress = parseInt(localStorage.getItem('languageSenseiEggProgress')) || 0;
  unlockedPets = JSON.parse(localStorage.getItem('languageSenseiPets')) || [];
  console.log('Loaded egg progress:', eggProgress); // Debug line
  updateEggDisplays();
  updatePetsCollection();
}

function updateEggProgress(xpGained) {
  // Only update progress if we don't have an egg
  if (!hasEgg) {
    eggProgress += xpGained;
    console.log('Egg progress:', eggProgress); // Debug line
    
    if (eggProgress >= EGG_XP_REQUIREMENT) {
      hasEgg = true;
      eggProgress = 0;
      showEggMsg("ü•ö You found a mysterious egg!");
      saveEggAndPets();
    }
  }
  updateEggDisplays();
}

function updateEggDisplays() {
  const statusEl = document.getElementById('egg-status');
  const progressBar = document.getElementById('egg-progress-bar');
  const progressText = document.getElementById('egg-progress-text');
  const hatchBtn = document.getElementById('hatch-egg-btn');
  
  if (statusEl) {
    statusEl.textContent = hasEgg ? "Ready to hatch!" : "No egg available";
  }
  if (progressBar) {
    const percent = hasEgg ? 100 : (eggProgress / EGG_XP_REQUIREMENT) * 100;
    progressBar.style.width = `${percent}%`;
  }
  if (progressText) {
    progressText.textContent = hasEgg ? "100" : String(eggProgress);
  }
  if (hatchBtn) {
    hatchBtn.classList.toggle('hidden', !hasEgg);
  }
}

function hatchEgg() {
  if (!hasEgg) return;
  
  // Get available pets (ones we don't have yet)
  const availablePets = Object.values(PETS).filter(pet => 
    !unlockedPets.some(p => p.name === pet.name)
  );
  
  if (availablePets.length === 0) {
    showEggMsg("You've collected all pets!");
    return;
  }
  
  // Randomly select a new pet
  const newPet = availablePets[Math.floor(Math.random() * availablePets.length)];
  unlockedPets.push(newPet);
  hasEgg = false;
  
  showEggMsg(`üéâ Your egg hatched into a ${newPet.emoji} ${newPet.name} (${newPet.nickname})!`);
  saveEggAndPets();
  updateEggDisplays();
  updatePetsCollection();
}

function updatePetsCollection() {
  const container = document.getElementById('pets-collection');
  if (!container) return;
  
  container.innerHTML = '';
  
  Object.values(PETS).forEach(pet => {
    const hasPet = unlockedPets.some(p => p.name === pet.name);
    const div = document.createElement('div');
    div.className = `text-center p-2 ${hasPet ? '' : 'opacity-40'}`;
    div.innerHTML = `
      <div class="text-2xl mb-1">${pet.emoji}</div>
      <div class="text-xs font-bold">${pet.name}</div>
      <div class="text-xs text-gray-400">${hasPet ? pet.nickname : '???'}</div>
    `;
    container.appendChild(div);
  });
}

function showEggMsg(msg) {
  alert(msg);
}

function saveGreenTea() {
  localStorage.setItem('languageSenseiGreenTea', greenTeaCount);
  localStorage.setItem('languageSenseiGreenTeaLastGiven', greenTeaLastGiven);
}

function loadGreenTea() {
  greenTeaCount = parseInt(localStorage.getItem('languageSenseiGreenTea'), 10) || 0;
  greenTeaLastGiven = parseInt(localStorage.getItem('languageSenseiGreenTeaLastGiven'), 10) || Date.now();
  updateGreenTeaDisplays();
}

// Give one green tea every 5 minutes if not maxed
function startGreenTeaTimer() {
  if (greenTeaTimer) clearInterval(greenTeaTimer);
  greenTeaTimer = setInterval(() => {
    updateGreenTeaTimerDisplay();
    if (greenTeaCount < GREEN_TEA_MAX) {
      let now = Date.now();
      if (now - greenTeaLastGiven >= GREEN_TEA_INTERVAL) {
        greenTeaCount++;
        greenTeaLastGiven = now;
        saveGreenTea();
        updateGreenTeaDisplays();
        showGreenTeaMsg("üçµ You received a Green Tea! (" + greenTeaCount + "/" + GREEN_TEA_MAX + ")");
      }
    }
  }, 1000);
}

// --- Sushi System ---
function saveSushi() {
  localStorage.setItem('languageSenseiSushi', sushiCount);
  localStorage.setItem('languageSenseiSushiProgress', sushiProgress);
}

function loadSushi() {
  sushiCount = parseInt(localStorage.getItem('languageSenseiSushi'), 10) || 0;
  sushiProgress = parseInt(localStorage.getItem('languageSenseiSushiProgress'), 10) || 0;
  updateSushiDisplays();
}

function updateSushiProgress(xpGained) {
  sushiProgress += xpGained;
  if (sushiProgress >= SUSHI_XP_REQUIREMENT) {
    if (sushiCount < SUSHI_MAX) {
      sushiCount++;
      showSushiMsg(`üç£ You earned a Sushi! (${sushiCount}/${SUSHI_MAX})`);
    }
    sushiProgress = 0;
  }
  saveSushi();
  updateSushiDisplays();
}

function updateSushiDisplays() {
  const countEl = document.getElementById('sushi-count-modal');
  const progressBar = document.getElementById('sushi-progress-bar');
  const progressText = document.getElementById('sushi-progress-text');
  const useButton = document.getElementById('use-sushi-btn');
  
  if (countEl) countEl.textContent = sushiCount;
  if (progressBar) {
    const percent = (sushiProgress / SUSHI_XP_REQUIREMENT) * 100;
    progressBar.style.width = `${percent}%`;
  }
  if (progressText) progressText.textContent = `${sushiProgress}`;
  if (useButton) useButton.disabled = sushiCount <= 0;
}

function useSushi(fromModal) {
  if (sushiCount > 0) {
    sushiCount--;
    saveSushi();
    updateSushiDisplays();
    addXP(SUSHI_XP_REWARD);
    showSushiMsg("üç£ You used a Sushi! +20 XP");
  } else {
    showSushiMsg("No Sushi to use!");
  }
}

function showSushiMsg(msg) {
  alert(msg);
}

function getNextGreenTeaTimeLeft() {
  if (greenTeaCount >= GREEN_TEA_MAX) return 0;
  let now = Date.now();
  let timePassed = now - greenTeaLastGiven;
  let left = GREEN_TEA_INTERVAL - timePassed;
  return left > 0 ? left : 0;
}

function formatTime(ms) {
  let total = Math.ceil(ms/1000);
  let min = Math.floor(total/60);
  let sec = total%60;
  return `${min.toString().padStart(2,"0")}:${sec.toString().padStart(2,"0")}`;
}

// Update Green Tea timer display
function updateGreenTeaTimerDisplay() {
  const timerEl = document.getElementById('green-tea-timer');
  if (timerEl) {
    if (greenTeaCount >= GREEN_TEA_MAX) {
      timerEl.textContent = "Full";
    } else {
      const now = Date.now();
      const timePassed = now - greenTeaLastGiven;
      const timeLeft = Math.max(0, GREEN_TEA_INTERVAL - timePassed);
      const minutes = Math.floor(timeLeft / 60000);
      const seconds = Math.floor((timeLeft % 60000) / 1000);
      timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
  }
}

// Start Green Tea timer
function startGreenTeaTimer() {
  if (greenTeaTimer) clearInterval(greenTeaTimer);
  
  greenTeaTimer = setInterval(() => {
    const now = Date.now();
    if (greenTeaCount < GREEN_TEA_MAX && (now - greenTeaLastGiven >= GREEN_TEA_INTERVAL)) {
      greenTeaCount++;
      greenTeaLastGiven = now;
      saveGreenTea();
      updateGreenTeaDisplays();
      showGreenTeaMsg(`üçµ You received a Green Tea! (${greenTeaCount}/${GREEN_TEA_MAX})`);
    }
    updateGreenTeaTimerDisplay();
  }, 1000);
}

function updateGreenTeaDisplays() {
  let el1 = document.getElementById('green-tea-count');
  let el2 = document.getElementById('green-tea-count-modal');
  if (el1) el1.textContent = greenTeaCount;
  if (el2) el2.textContent = greenTeaCount;
  updateGreenTeaTimerDisplay();
}

function useGreenTea(fromModal) {
  if (greenTeaCount > 0) {
    greenTeaCount--;
    saveGreenTea();
    updateGreenTeaDisplays();
    addXP(15); // +15 XP per use
    showGreenTeaMsg("üçµ You used a Green Tea! +15 XP");
    if (fromModal) updateGreenTeaDisplays();
  } else {
    showGreenTeaMsg("No Green Tea to use!");
  }
}

function showGreenTeaMsg(msg) {
  // You can make this fancier (e.g., toast) if you wish
  alert(msg);
}

// --- Inventory Menu Modal logic ---
function openInventoryMenu() {
  const modal = document.getElementById('inventory-modal');
  modal.style.display = "flex";
  setTimeout(() => modal.classList.add('show'), 10); // allow reflow for transition
  updateGreenTeaDisplays();
}

function closeInventoryMenu() {
  const modal = document.getElementById('inventory-modal');
  modal.classList.remove('show');
  setTimeout(() => modal.style.display = "none", 10); // matches CSS transition time
}

// Button listeners (add at end of script)
document.getElementById('open-inventory-btn').onclick = openInventoryMenu;
document.getElementById('close-inventory-btn').onclick = closeInventoryMenu;

    // --- Progress/XP logic ---
    function getTodayString() {
      const now = new Date();
      return now.toISOString().slice(0, 10);
    }

    function loadProgress() {
      const savedXP = localStorage.getItem('languageSenseiDailyXP');
      const savedStreak = localStorage.getItem('languageSenseiStreakDays');
      const savedTotalXP = localStorage.getItem('languageSenseiTotalXP');
      const savedLastStreakDate = localStorage.getItem('languageSenseiLastStreakDate');
      const savedDoubleXp = localStorage.getItem('languageSenseiDoubleXpUntil');

      currentXP = savedXP !== null ? parseInt(savedXP, 10) : 0;
      currentStreak = savedStreak !== null ? parseInt(savedStreak, 10) : 0;
      totalXP = savedTotalXP !== null ? parseInt(savedTotalXP, 10) : 0;
      lastStreakDate = savedLastStreakDate || null;

      if (savedDoubleXp) {
        const until = parseInt(savedDoubleXp, 10);
        if (Date.now() < until) {
          activateDoubleXp(until - Date.now());
        } else {
          deactivateDoubleXp();
        }
      } else {
        deactivateDoubleXp();
      }

      if (isNaN(currentXP)) currentXP = 0;
      if (isNaN(currentStreak)) currentStreak = 0;
      if (isNaN(totalXP)) totalXP = 0;
      updateProgressDisplay();
    }

    function saveProgress() {
  // Fix XP saving
  localStorage.setItem('languageSenseiDailyXP', currentXP.toString());
  localStorage.setItem('languageSenseiStreakDays', currentStreak.toString());
  localStorage.setItem('languageSenseiTotalXP', totalXP.toString());
  localStorage.setItem('languageSenseiLastStreakDate', lastStreakDate || '');
  
  // Save Sushi progress too
  saveSushi();
}

function loadProgress() {
  // Load XP and streak data
  currentXP = parseInt(localStorage.getItem('languageSenseiDailyXP')) || 0;
  currentStreak = parseInt(localStorage.getItem('languageSenseiStreakDays')) || 0;
  totalXP = parseInt(localStorage.getItem('languageSenseiTotalXP')) || 0;
  lastStreakDate = localStorage.getItem('languageSenseiLastStreakDate') || null;

  // Load double XP status
  const savedDoubleXp = localStorage.getItem('languageSenseiDoubleXpUntil');
  if (savedDoubleXp) {
    const until = parseInt(savedDoubleXp, 10);
    if (Date.now() < until) {
      activateDoubleXp(until - Date.now());
    } else {
      deactivateDoubleXp();
    }
  }

  updateProgressDisplay();
}

function addXP(amount) {
  let xpToAdd = isDoubleXpActive ? amount * 2 : amount;
  currentXP += xpToAdd;
  totalXP += xpToAdd;

  // Update Sushi and Egg progress
  updateSushiProgress(xpToAdd);
  updateEggProgress(xpToAdd); // Make sure this line is here

  let today = getTodayString();
  let streakUpdatedToday = lastStreakDate === today;

  if (currentXP >= DAILY_XP_MAX && !streakUpdatedToday) {
    currentXP = 0;
    currentStreak++;
    lastStreakDate = today;
  }
  if (currentXP >= DAILY_XP_MAX && streakUpdatedToday) {
    currentXP = 0;
  }

  updateProgressDisplay();
  saveProgress();
}
    function updateProgressDisplay() {
      streakDaysEl.textContent = currentStreak;
      let percent = (currentXP / DAILY_XP_MAX) * 100;
      if (percent > 100) percent = 100;
      xpBarFill.style.width = percent + '%';
      xpText.textContent = `XP: ${currentXP} / ${DAILY_XP_MAX}`;
      totalXpText.textContent = `Total XP: ${totalXP}`;
      doubleXpBtn.textContent = isDoubleXpActive ? "2x XP ACTIVE" : "2x XP (ad)";
      doubleXpBtn.disabled = isDoubleXpActive;
      doubleXpBtn.classList.toggle("opacity-60", isDoubleXpActive);
      doubleXpBtn.classList.toggle("cursor-not-allowed", isDoubleXpActive);
    }


    function activateDoubleXp(duration = DOUBLE_XP_DURATION) {
      isDoubleXpActive = true;
      updateProgressDisplay();
      if (doubleXpTimeout) clearTimeout(doubleXpTimeout);
      if (doubleXpInterval) clearInterval(doubleXpInterval);

      const until = Date.now() + duration;
      doubleXpEndTimestamp = until;
      localStorage.setItem('languageSenseiDoubleXpUntil', until.toString());
      showDoubleXpTimer();

      doubleXpTimeout = setTimeout(() => {
        deactivateDoubleXp();
      }, duration);

      doubleXpInterval = setInterval(updateDoubleXpTimer, 1000);
      updateDoubleXpTimer();
    }

    function deactivateDoubleXp() {
      isDoubleXpActive = false;
      doubleXpEndTimestamp = null;
      updateProgressDisplay();
      localStorage.removeItem('languageSenseiDoubleXpUntil');
      if (doubleXpTimeout) clearTimeout(doubleXpTimeout);
      if (doubleXpInterval) clearInterval(doubleXpInterval);
      hideDoubleXpTimer();
    }

    function showDoubleXpTimer() {
      doubleXpTimerBox.classList.add('show');
      doubleXpTimerBox.classList.remove('hide');
      updateDoubleXpTimer();
    }
    function hideDoubleXpTimer() {
      doubleXpTimerBox.classList.remove('show');
      doubleXpTimerBox.classList.add('hide');
      setTimeout(() => {
        doubleXpTimerBox.style.display = "none";
        doubleXpTimerBox.classList.remove('hide');
      }, 400);
    }
    function formatTimeLeft(ms) {
      let totalSeconds = Math.max(0, Math.floor(ms / 1000));
      let min = Math.floor(totalSeconds / 60);
      let sec = totalSeconds % 60;
      return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }
    function updateDoubleXpTimer() {
      if (!isDoubleXpActive || !doubleXpEndTimestamp) return;
      const msLeft = doubleXpEndTimestamp - Date.now();
      if (msLeft <= 0) {
        deactivateDoubleXp();
        return;
      }
      doubleXpTimerBox.style.display = "block";
      doubleXpTimerText.textContent = `2x XP active: ${formatTimeLeft(msLeft)}`;
    }

    doubleXpBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (doubleXpBtn.disabled) return;
      activateDoubleXp();
    });

    // --- Dropdown logic ---
    langToggle.addEventListener('click', function(e) {
      if (langOptions.classList.contains('hidden')) {
        langOptions.classList.remove('hidden');
        setTimeout(() => {
          langOptions.classList.add('opacity-100');
          langOptions.classList.remove('opacity-0');
          langOptions.classList.remove('pointer-events-none');
          langOptions.classList.add('pointer-events-auto');
        }, 10);
      } else {
        langOptions.classList.remove('opacity-100');
        langOptions.classList.add('opacity-0');
        langOptions.classList.remove('pointer-events-auto');
        langOptions.classList.add('pointer-events-none');
        setTimeout(() => langOptions.classList.add('hidden'), 500);
      }
    });

    // --- Section nav logic ---
    function hideAllSections() {
      [hiraganaSection, katakanaSection, kanjiSection, wordsSection, quizContainer, wordsQuizGame].forEach(sec => {
        if (!sec.classList.contains('hidden')) sec.classList.add('hidden');
        sec.classList.remove('opacity-100');
      });
    }

    hiraganaBtn.addEventListener('click', function(e) {
      quizType = 'hiragana';
      hideAllSections();
      welcomeText.classList.add('opacity-0');
      setTimeout(() => {
        welcomeText.classList.add('hidden');
        hiraganaSection.classList.remove('hidden');
        setTimeout(() => hiraganaSection.classList.add('opacity-100'), 10);
        hiraganaSection.classList.remove('opacity-0');
        loadKanaCharacters(hiraganaGrid, hiraganaCharacters, 'h');
      }, 500);
    });

    katakanaBtn.addEventListener('click', function(e) {
      quizType = 'katakana';
      hideAllSections();
      welcomeText.classList.add('opacity-0');
      setTimeout(() => {
        welcomeText.classList.add('hidden');
        katakanaSection.classList.remove('hidden');
        setTimeout(() => katakanaSection.classList.add('opacity-100'), 10);
        katakanaSection.classList.remove('opacity-0');
        loadKanaCharacters(katakanaGrid, katakanaCharacters, 'k');
      }, 500);
    });

    kanjiBtn.addEventListener('click', function(e) {
      quizType = 'kanji';
      hideAllSections();
      welcomeText.classList.add('opacity-0');
      setTimeout(() => {
        welcomeText.classList.add('hidden');
        kanjiSection.classList.remove('hidden');
        setTimeout(() => kanjiSection.classList.add('opacity-100'), 10);
        kanjiSection.classList.remove('opacity-0');
        loadKanaCharacters(kanjiGrid, kanjiCharacters, 'kanji');
      }, 500);
    });

    wordsBtn.addEventListener('click', function(e) {
      quizType = 'words';
      hideAllSections();
      welcomeText.classList.add('opacity-0');
      setTimeout(() => {
        welcomeText.classList.add('hidden');
        wordsSection.classList.remove('hidden');
        setTimeout(() => wordsSection.classList.add('opacity-100'), 10);
        wordsSection.classList.remove('opacity-0');
        wordsQuizContainer.innerHTML = '';
      }, 500);
    });

    // --- Kana Grid Logic (for all) ---
    function loadKanaCharacters(gridElem, chars, prefix) {
      gridElem.innerHTML = '';
      chars.forEach(([kana, reading]) => {
        const label = document.createElement('label');
        label.className = "flex flex-col items-center bg-red-600 rounded-lg p-2 cursor-pointer select-none";
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = reading;
        checkbox.className = 'mb-1';
        checkbox.name = prefix + '-kana-choice';
        const spanKana = document.createElement('span');
        spanKana.className = 'text-3xl akaya';
        spanKana.textContent = kana;
        const spanRomaji = document.createElement('span');
        spanRomaji.className = 'text-sm';
        spanRomaji.textContent = `(${reading})`;
        label.appendChild(checkbox);
        label.appendChild(spanKana);
        label.appendChild(spanRomaji);
        gridElem.appendChild(label);
      });
    }

    // --- Select/Deselect All ---
    document.getElementById('select-all-btn-h').addEventListener('click', function(e) {
      document.querySelectorAll('#hiragana-grid input[type="checkbox"]').forEach(cb => cb.checked = true);
    });
    document.getElementById('deselect-all-btn-h').addEventListener('click', function(e) {
      document.querySelectorAll('#hiragana-grid input[type="checkbox"]').forEach(cb => cb.checked = false);
    });

    document.getElementById('select-all-btn-k').addEventListener('click', function(e) {
      document.querySelectorAll('#katakana-grid input[type="checkbox"]').forEach(cb => cb.checked = true);
    });
    document.getElementById('deselect-all-btn-k').addEventListener('click', function(e) {
      document.querySelectorAll('#katakana-grid input[type="checkbox"]').forEach(cb => cb.checked = false);
    });

    document.getElementById('select-all-btn-kanji').addEventListener('click', function(e) {
      document.querySelectorAll('#kanji-grid input[type="checkbox"]').forEach(cb => cb.checked = true);
    });
    document.getElementById('deselect-all-btn-kanji').addEventListener('click', function(e) {
      document.querySelectorAll('#kanji-grid input[type="checkbox"]').forEach(cb => cb.checked = false);
    });

    // --- Start Quiz Buttons ---
    startQuizBtnH.addEventListener('click', function(e) {
      startKanaQuiz('hiragana');
    });
    startQuizBtnK.addEventListener('click', function(e) {
      startKanaQuiz('katakana');
    });
    startQuizBtnKanji.addEventListener('click', function(e) {
      startKanaQuiz('kanji');
    });

// Show ad on 2x click
document.getElementById('activateDoubleXp').addEventListener('click', function(e) {
  e.preventDefault();
  document.getElementById('double-xp-ad').style.display = 'flex';
});

// Hide ad on close
document.getElementById('close-double-xp-ad').addEventListener('click', function() {
  document.getElementById('double-xp-ad').style.display = 'none';
});



    function startKanaQuiz(type) {
      let gridId, chars;
      if (type === 'hiragana') {
        gridId = '#hiragana-grid';
        chars = hiraganaCharacters;
      } else if (type === 'katakana') {
        gridId = '#katakana-grid';
        chars = katakanaCharacters;
      } else if (type === 'kanji') {
        gridId = '#kanji-grid';
        chars = kanjiCharacters;
      }

      const selected = Array.from(document.querySelectorAll(gridId + ' input[type="checkbox"]:checked'))
        .map(cb => cb.value);

      if (selected.length === 0) {
        alert('Please select at least one character to start the quiz!');
        return;
      }

      quizType = type;
      quizItems = chars.filter(([kana, reading]) => selected.includes(reading));
      quizItems = shuffleArray(quizItems);
      currentIndex = 0;
      score = 0;
      feedback.textContent = '';
      scoreDisplay.textContent = '';
      goBackBtn.classList.add('hidden');

      let section = type === 'hiragana' ? hiraganaSection : type === 'katakana' ? katakanaSection : kanjiSection;
      section.classList.add('opacity-0');
      setTimeout(() => {
        section.classList.add('hidden');
        quizContainer.classList.remove('hidden');
        setCurvedVisibility(true);
        setTimeout(() => quizContainer.classList.add('opacity-100'), 10);
        quizContainer.classList.remove('opacity-0');
        loadProgress();
        showNextQuestion();
      }, 500);
    }

    skipQuestionBtn.addEventListener('click', function(e) {
      feedback.textContent = '';
      currentIndex++;
      showNextQuestion();
    });

    goBackBtn.addEventListener('click', function(e) {
      quizContainer.classList.add('opacity-0');
      setTimeout(() => {
        quizContainer.classList.add('hidden');
        setCurvedVisibility(false);
        welcomeText.classList.remove('hidden');
        welcomeText.classList.remove('opacity-0');
      }, 500);
    });

    function setCurvedVisibility(show) {
      curvedTop.style.display = show ? 'block' : 'none';
    }

    function shuffleArray(array) {
      let arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function showNextQuestion() {
      if (currentIndex >= quizItems.length) {
        quizQuestion.textContent = 'Quiz Complete!';
        choicesContainer.innerHTML = '';
        feedback.textContent = `Final score: ${score} / ${quizItems.length}`;
        scoreDisplay.textContent = '';
        goBackBtn.classList.remove('hidden');
        skipQuestionBtn.classList.add('hidden');
        
        return;
      }

      skipQuestionBtn.classList.remove('hidden');
      goBackBtn.classList.add('hidden');
      scoreDisplay.textContent = `Score: ${score} / ${currentIndex}`;
      questionMode = Math.random() < 0.5 ? 0 : 1;

      // select chars for this quiz
      let chars;
      if (quizType === 'hiragana') {
        chars = hiraganaCharacters;
      } else if (quizType === 'katakana') {
        chars = katakanaCharacters;
      } else if (quizType === 'kanji') {
        chars = kanjiCharacters;
      }
      const [kana, reading] = quizItems[currentIndex];
      let questionText, correctAnswer, allOptions = [];
      if (quizType === 'kanji') {
        // Always Kanji -> hiragana quiz
        questionText = kana;
        correctAnswer = reading;
        const wrongOptions = chars.filter(item => item[1] !== correctAnswer).map(item => item[1]);
        shuffleArray(wrongOptions);
        allOptions = wrongOptions.slice(0, 3);
        allOptions.push(correctAnswer);
      } else if (questionMode === 0) {
        questionText = kana;
        correctAnswer = reading;
        const wrongOptions = chars.filter(item => item[1] !== correctAnswer).map(item => item[1]);
        shuffleArray(wrongOptions);
        allOptions = wrongOptions.slice(0, 3);
        allOptions.push(correctAnswer);
      } else {
        questionText = reading;
        correctAnswer = kana;
        const wrongOptions = chars.filter(item => item[0] !== correctAnswer).map(item => item[0]);
        shuffleArray(wrongOptions);
        allOptions = wrongOptions.slice(0, 3);
        allOptions.push(correctAnswer);
      }
      allOptions = shuffleArray(allOptions);
      quizQuestion.textContent = questionText;
      choicesContainer.innerHTML = '';
      allOptions.forEach(option => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.textContent = option;
        btn.disabled = false;
        btn.addEventListener('click', function() {
          if (btn.disabled) return;
          Array.from(choicesContainer.children).forEach(b => b.disabled = true);

          if (option === correctAnswer) {
            btn.classList.add('correct');
            feedback.textContent = isDoubleXpActive ? 'Correct! +4 XP (2x XP)' : 'Correct! +2 XP';
            score++;
            addXP(XP_PER_CORRECT);
          } else {
            btn.classList.add('incorrect');
            feedback.textContent = `Wrong! Correct answer: ${correctAnswer}`;
          }
          scoreDisplay.textContent = `Score: ${score} / ${currentIndex + 1}`;
          setTimeout(() => {
            feedback.textContent = '';
            currentIndex++;
            showNextQuestion();
          }, 1200);
        });
        choicesContainer.appendChild(btn);
      });
    }

    // --- Words Quiz ---
    startQuizBtnWords.addEventListener('click', function(e) {
      // Use random 20 from 50
      wordsQuizData = shuffleArray(commonWords).slice(0, 20);
      wordsQuizCurrent = 0;
      wordsQuizScore = 0;
      wordsQuizFeedback.textContent = '';
      wordsQuizScoreElem.textContent = '';
      wordsSection.classList.add('opacity-0');
      setTimeout(() => {
        wordsSection.classList.add('hidden');
        wordsQuizGame.classList.remove('hidden');
        setTimeout(() => wordsQuizGame.classList.add('opacity-100'), 10);
        wordsQuizGame.classList.remove('opacity-0');
        showWordsQuizQuestion();
      }, 500);
    });

    function showWordsQuizQuestion() {
      if (wordsQuizCurrent >= wordsQuizData.length) {
        // Quiz done
        wordsQuizWord.innerHTML = 'Quiz Complete!';
        wordsQuizChoices.innerHTML = '';
        wordsQuizFeedback.textContent = `Final score: ${wordsQuizScore} / ${wordsQuizData.length}`;
        wordsQuizScoreElem.textContent = '';
        wordsQuizNextBtn.classList.add('hidden');
        wordsQuizFinishBtn.classList.add('hidden');
        wordsQuizBackBtn.classList.remove('hidden');
        return;
      }
      wordsQuizBackBtn.classList.add('hidden');
      wordsQuizNextBtn.classList.add('hidden');
      wordsQuizFinishBtn.classList.add('hidden');
      wordsQuizFeedback.textContent = '';
      wordsQuizScoreElem.textContent = `Score: ${wordsQuizScore} / ${wordsQuizCurrent}`;
      const q = wordsQuizData[wordsQuizCurrent];
      wordsQuizWord.innerHTML = `<span class="font-bold">${q.meaning}</span>`;
      // Choices: correct + 3 random wrong
      let wrongs = shuffleArray(commonWords.filter(w => w.word !== q.word)).slice(0, 3);
      let options = wrongs.map(w => w.word);
      options.push(q.word);
      options = shuffleArray(options);
      wordsQuizChoices.innerHTML = '';
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.textContent = opt;
        btn.disabled = false;
        btn.addEventListener('click', function() {
          if (btn.disabled) return;
          Array.from(wordsQuizChoices.children).forEach(b => b.disabled = true);
          if (opt === q.word) {
            btn.classList.add('correct');
            wordsQuizFeedback.textContent = isDoubleXpActive ? 'Correct! +4 XP (2x XP)' : 'Correct! +2 XP';
            wordsQuizScore++;
            addXP(XP_PER_CORRECT);
          } else {
            btn.classList.add('incorrect');
            wordsQuizFeedback.textContent = `Wrong! Correct answer: ${q.word}`;
          }
          wordsQuizScoreElem.textContent = `Score: ${wordsQuizScore} / ${wordsQuizCurrent + 1}`;
          if (wordsQuizCurrent < wordsQuizData.length - 1) {
            wordsQuizNextBtn.classList.remove('hidden');
            wordsQuizFinishBtn.classList.add('hidden');
          } else {
            wordsQuizFinishBtn.classList.remove('hidden');
            wordsQuizNextBtn.classList.add('hidden');
          }
        });
        wordsQuizChoices.appendChild(btn);
      });
    }

    wordsQuizNextBtn.addEventListener('click', function() {
      wordsQuizCurrent++;
      showWordsQuizQuestion();
    });
    wordsQuizFinishBtn.addEventListener('click', function() {
      wordsQuizCurrent++;
      showWordsQuizQuestion();
    });
    wordsQuizBackBtn.addEventListener('click', function() {
      wordsQuizGame.classList.add('opacity-0');
      setTimeout(() => {
        wordsQuizGame.classList.add('hidden');
        welcomeText.classList.remove('hidden');
        welcomeText.classList.remove('opacity-0');
      }, 500);
    });

    // --- Helper ---
    function shuffleArray(array) {
      let arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function setCurvedVisibility(show) {
      curvedTop.style.display = show ? 'block' : 'none';
    }


document.addEventListener('DOMContentLoaded', function() {
  // Initialize datetime display
  function updateDateTime() {
    const now = new Date();
    const formatted = now.getUTCFullYear() + '-' + 
                     String(now.getUTCMonth() + 1).padStart(2, '0') + '-' +
                     String(now.getUTCDate()).padStart(2, '0') + ' ' +
                     String(now.getUTCHours()).padStart(2, '0') + ':' +
                     String(now.getUTCMinutes()).padStart(2, '0') + ':' +
                     String(now.getUTCSeconds()).padStart(2, '0');
    
    document.getElementById('current-datetime').textContent = formatted;
  }
  
  setInterval(updateDateTime, 1000);
  updateDateTime();
  
  // Set user login
  document.getElementById('user-login').textContent = 'Repzal';
  
  // Initialize game systems
  console.log('Initializing game systems...'); // Debug log
  loadGreenTea();
  startGreenTeaTimer();
  loadSushi();
  loadEggAndPets();
  loadProgress();
  
  // Add modal update listener
  const inventoryBtn = document.getElementById('open-inventory-btn');
  if (inventoryBtn) {
    inventoryBtn.addEventListener('click', function() {
      console.log('Opening inventory...'); // Debug log
      updateEggDisplays();
      updatePetsCollection();
    });
  }
});

// Add save/load debug logs
function saveEggAndPets() {
  localStorage.setItem('languageSenseiEggStatus', hasEgg.toString());
  localStorage.setItem('languageSenseiEggProgress', eggProgress.toString());
  localStorage.setItem('languageSenseiPets', JSON.stringify(unlockedPets));
  console.log('Saved egg data:', { hasEgg, eggProgress, unlockedPets }); // Debug log
}

function loadEggAndPets() {
  hasEgg = localStorage.getItem('languageSenseiEggStatus') === 'true';
  eggProgress = parseInt(localStorage.getItem('languageSenseiEggProgress')) || 0;
  unlockedPets = JSON.parse(localStorage.getItem('languageSenseiPets')) || [];
  console.log('Loaded egg data:', { hasEgg, eggProgress, unlockedPets }); // Debug log
  updateEggDisplays();
  updatePetsCollection();
}
  </script>
  
  
</body>
</html>
